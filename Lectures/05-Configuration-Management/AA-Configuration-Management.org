#+Title: Configuration Management
#+Author: Mikael Svahnberg
#+Email: Mikael.Svahnberg@bth.se
#+Date: 2025-04-02
#+EPRESENT_FRAME_LEVEL: 1
#+OPTIONS: email:t <:t todo:t f:t ':t H:1
#+STARTUP: beamer num

#+LATEX_CLASS_OPTIONS: [10pt,t,a4paper]
#+BEAMER_THEME: BTH2025

* Introduction
- Grunderna i Konfigurationshantering
- Thomas & Hunt; Kapitel 3: The Basic Tools

\sum Allt √§r text. /Allt skall Konfigurationshanteras!/
* Konfigurationshantering
- /Versionshantering/ kontra /Konfigurationhantering/
- Versionshantering:
  - En gigantisk undo-knapp f√∂r en hel fil.
  - Automatiskt sk√∂tt, inte en massa idioti med att d√∂pa om filerna efter vem som har √§ndrat dem.
- Konfifurationshantering sk√∂ter dessutom
  - Vilka versioner av filer fungerar ihop?
  - I vilka filer implementerar vi /feature X/
  - I vilka filer l√∂ser vi /issue Y/ (Bug/feature request/\dots )?
  - Vilka versioner av alla filer √§r det som k√∂r hos /Kund Z/?
  - St√∂d f√∂r (semi-) automatisk /merge/ om flera har √§ndrat filen
  - St√∂d f√∂r att utveckla samma fil samtidigt f√∂r olika features.

- K√§nda verktyg (idag)
  - Subversion ::
    - Klassiskt server-orienterat: all CM sker p√• en och samma server
  - Git ::
    - Anv√§nds av de flesta idag
    - I teorin distribuerat; i praktiken ocks√• server-orienterat
  - Mercurial ::
    - Liknar git, men anses av m√•nga vara lite enklare
* Hela projektet skall alltid konfigurationshanteras
- K√§llkod
- Designdokumentation
- Dokumentation
- Script f√∂r att bygga applikationen
- Script f√∂r att st√§lla i ordning utvecklingsmilj√∂n / testmilj√∂n / produktionsmilj√∂n
- Script f√∂r att starta applikationen

* Anv√§nd Alltid Konfigurationshantering
- √Ñven om det √§r ditt eget hobbyprojekt
- Inklusive konfigurationsfiler f√∂r att st√§lla i ordning din dator och utvecklingsmilj√∂
  - Sv√•rt om allt ligger i windows registry
  - L√§tt (och sj√§lvklart) om allt finns i .rc-filer i din anv√§ndarkatalog

*If it's not comitted, it does not exist!*
* Det b√∂rjar med en Branch...
#+begin_src dot :file branch1.png
  digraph G {
          rankdir="LR";
          bgcolor="transparent";
          node[width=0.15, height=0.15, shape=point, color=black];
          edge[weight=2, arrowhead=none, color=darkgray];
          node[group=master];
          1 -> 2 -> 3 -> 4 -> 5;
          node[group=branch];
          //2 -> 6 -> 7 -> 4;
  }
#+end_src

#+RESULTS:
[[file:branch1.png]]

- K√§rnan i all konfigurationshantering √§r att inse att du /alltid/ arbetar p√• en gren
  - Du arbetar med filerna p√• en delad n√§tverkskatalog
  - Du kopierar projektet till din dator
  - Du klonar projektet
  - Du skapar en ny gren f√∂r att implementera en ny feature

- Utmaningen blir alltid att kombinera f√∂rgreningar med en /merge/
  - Om du √§r den enda som har redigerat en viss fil
  - Om du √§r den enda som har redigerat en viss del av en fil
  - Om ni √§r flera som har redigerat samma del av en viss fil
  - Om du har redigerat en fil som n√•gon annan har tagit bort

#+begin_src dot :file branch2.png
  digraph G {
          rankdir="LR";
          bgcolor="transparent";
          node[width=0.15, height=0.15, shape=point, color=black];
          edge[weight=2, arrowhead=none, color=darkgray];
          node[group=master];
          1 -> 2 -> 3 -> 4 -> 5;
          node[group=branch];
          2 -> 6 -> 7 -> 4;
  }
#+end_src

#+RESULTS:
[[file:branch2.png]]

* Commit
[[./branch2.png]]

- Ofta beh√∂ver man redigera flera filer f√∂r att l√∂sa en uppgift
- Paketera alla redigerade filer i en =commit=
- En commit har ocks√• ett meddelande som ber√§ttar vad man gjort.
  - Ofta l√§nkat med krav-databasen eller issue-databasen
  - T.ex. Meddelandet ~Fixes #222~ kommer l√§nka denna commit med issue #222.
- Den senaste committen kallas f√∂r /head/

*Meddelandet skall vara kort men beskrivande*
- inte bara "redigerade x.txt", utan /varf√∂r/, t.ex. "bakgrund om glasstilverkning.", eller "Implementerar krav #23"
- en commit == ett syfte. Flera syften, flera commits.
* Arbeta Lokalt
- Det g√•r att anv√§nda konfigurationshantering lokalt, bara f√∂r dig och din dator
- Sparar gamla versioner -- lokal backup
- H√•ll is√§r varje projekt -- en filsystemskatalog f√∂r varje
  - Program du vill skriva
  - Rapport du arbetar med
  - Kurs du g√•r
  - Laboration i Kurs
- Samla och beskriv √§ndringar/framsteg
  - Varje commit √§r ett helt meningsfullt bidrag
  - En viss commit inneh√•ller alla filer som √§ndrades i det bidraget
  - \dots med automatiskt versionsnummer

** Exempel -- S√• Arbetar Jag
- I huvudsak tre kataloger:
  - =~/Documents/Personal=
  - =~/Documents/Research=
  - =~/Documents/Teaching=
- Under dessa har jag projekt
  - En katalog per projekt
  - Varje katalog √§r konfigurationshanterad

#+ATTR_ORG: :width 1024px
#+begin_src dot :file mydir.png
   digraph G {
           rankdir="LR"; 
           bgcolor="transparent";
           node[width=3, height=0.4, shape=folder, fontsize=12.0, color=black, fontcolor=black];
           edge[weight=2, arrowhead=none, color=darkgray];
           "üìÇ ~/Documents/" -> "üìÇ Personal"
           "üìÇ ~/Documents/" -> "üìÇ Research"
           "üìÇ ~/Documents/" -> "üìÇ Teaching"
           "üìÇ Teaching" -> "‚éá PA1458-OODesign"
           "üìÇ Teaching" -> "‚éá PA1461-Intro-ICT"
           "üìÇ Teaching" -> "‚éá PA1482-Applied-OO-Design"
           "üìÇ Teaching" -> "‚éá PA1489-Basics-SE"
           "üìÇ Teaching" -> "‚éá PA2534-Thesis"
           "üìÇ Teaching" -> "‚éá PA2577-Cloud"
           "üìÇ Teaching" -> "‚éá PAAPT"
           "üìÇ Teaching" -> "‚éá GuestLectures"
           "‚éá PA1489-Basics-SE" -> "üóé Readme.md"
           "‚éá PA1489-Basics-SE" -> "üìÇ Assignments"
           "‚éá PA1489-Basics-SE" -> "üìÇ Evaluations"
           "‚éá PA1489-Basics-SE" -> "üìÇ Formalia"
           "‚éá PA1489-Basics-SE" -> "üìÇ Lectures"
           "‚éá PA1489-Basics-SE" -> "üìÇ Planning"
           "‚éá PA1489-Basics-SE" -> "üìÇ Results"
  }
#+end_src

#+ATTR_ORG: :width 800px
#+RESULTS:
[[file:mydir.png]]
* Flera Anv√§ndare
- F√∂r att samarbeta i ett projekt underl√§ttar det om man anv√§nder en /server/
- Du arbetar fortfarande lokalt p√• din egen kopia, din /branch/
- Det g√∂r dina kollegor ocks√•.
- Ni kommunicerar genom att ladda upp och ner till severn.

/Det h√§r skiljer sig fr√•n vad ni √§r vana vid/
- Med Teams, Google Drive, OneDrive, \dots arbetar ni alla mot /samma/ fil, /samtidigt/ p√• en server.
  - I en del program syns det att flera redigerar samtidigt
  - I m√•nga fall s√• blir det ett /race-condition/ om vem som sparar f√∂rst/sist
  - Den som sparar senast skriver √∂ver alla andras √§ndringar

#+begin_src dot :file sever-collab.png
  digraph G {
          rankdir="LR";
          bgcolor="transparent";
          node[width=0.15, height=0.15, shape=point, fontsize=10.0 color=black, fontcolor=black];
          edge[weight=2, arrowhead=none, color=darkgray];
          node[group=main];
          1 -> 2 -> 3 -> 4 -> 5 -> 6 -> 7;
          node[group=branch1];
          2 -> a -> b -> c -> d -> 5;

          1[shape=box,label="main"];
          a[shape=box,label="din kopia"];

          node[group=branch2];
          2 -> aa -> bb -> cc -> 6;
          aa[shape=box,label="din kompis kopia"];
  }

#+end_src

#+RESULTS:
[[file:sever-collab.png]]

* Flera F√∂rgreningar/Branches
:PROPERTIES:
:BEAMER_OPT: shrink=30
:END:

Man kan ha hur m√•nga f√∂rgreningar man vill, och skapa dem av vilka anledningar som helst.

#+begin_src dot :file collab-branching.png
  digraph G {
          rankdir="LR";
          bgcolor="transparent";
          node[width=0.15, height=0.15, shape=point, fontsize=10.0, color=black, fontcolor=black];
          edge[weight=2, arrowhead=none, color=darkgray];

          node[group=main];
          1 -> 2 -> 3 -> 4 -> 5 -> 6 -> 7;
          1[shape=box,label="main"];

          node[group=branch1];
          2 -> a -> b -> c -> d -> 5;
          a[shape=box,label="din kopia"];

          node[group=branch2];
          2 -> aa -> bb -> cc -> dd -> ee -> ff -> gg -> 6;
          aa[shape=box,label="din kompis kopia"];
          cc[shape=box,label="Feature 1"];

          node[group=branch3];
          bb -> aaa -> bbb -> ccc -> gg;
          aaa[shape=box,label="Feature 2"];
  }

#+end_src

#+RESULTS:
[[file:collab-branching.png]]

** Git Flow :Extra:
Ett strukturerat exempel p√• hur man kan arbeta √§r /Git Flow/-modellen:
- main :: H√•ller bara "stabila" releaser. Man arbetar inte p√• den h√§r f√∂rgreningen.
- develop :: Integration av features. Ingen nyutveckling h√§r, utan bara merge-arbete.
- feature :: En per feature man arbetar med. Ny feature == ny f√∂rgrening.
- release :: Fixa det sista innan man kan sl√§ppa n√§sta st√∂rre release.
- hotfix :: Om man absolut m√•ste fixa n√•got /just nu/ i den senaste produkten.
[[./git-example-git-flow.png]]

* Publicera √Ñndringar: Merge
[[file:collab-branching.png]]

- Varje g√•ng som tv√• linjer g√•r ihop i grafen:
  - "din kopia" g√•r ihop med "main"
  - "Feature 2" g√•r ihop med "Feature 1"
  - "Feature 1" g√•r ihop med "main"
- Det h√§r kallas en *Merge* och g√•r ut p√• att man
  1. byter till "f√∂r√§lder-f√∂rgreningen"  (ex. =byt till "main"=)
  2. h√§mtar f√∂r√§ndringarna (ex. =h√§mta filerna fr√•n "din kopia"=)
  3. committar f√∂r√§ndringarna (ex. =commit fil a,b till "main"=)
- Den nya committen √§r sedan tillg√§nglig till alla andra som anv√§nder den f√∂rgreningen.
  - \dots s√• snart de har h√§mtat den!
  - I exemplet ovan, s√• m√•ste din kompis h√§mta fr√•n "main" och sedan kombinera √§ndringarna i main med sin f√∂rgrening
* Att Hantera Merge
#+begin_src dot :file collab-branching-merge.png
  digraph G {
  rankdir="LR";
  bgcolor="transparent";
  node[width=0.15, height=0.15, shape=point, fontsize=10.0, color=black, fontcolor=black];
  edge[weight=2, arrowhead=none, color=darkgray];

  node[group=main];
  1 -> 2 -> 3 -> 4 -> 5 -> 6 -> 7;
  1[shape=box,label="main"];

  node[group=branch1];
  2 -> a -> b -> c -> d -> 5;
  a[shape=box,label="din kopia"];

  node[group=branch2];
  2 -> aa -> bb -> cc -> dd -> ee -> ff
  aa[shape=box,label="din kompis kopia"];
  cc[shape=box,label="Feature 1"];
  5 -> ff -> gg [color=darkred, arrowhead=normal];

  node[group=branch3];
  bb -> aaa -> bbb -> ccc;
  aaa[shape=box,label="Feature 2"];
  ccc -> gg -> 6 [color=darkred, arrowhead=normal];
  }

#+end_src

#+RESULTS:
[[file:collab-branching-merge.png]]


- Att kombinera olika f√∂rgreningar √§r sv√•rt.
- Moderna konfigurationshanteringsverktyg har slutat f√∂rs√∂ka.
  - De varnar anv√§ndaren och v√§grar forts√§tta tills dess konflikten √§r fixad.
- Strategi 1 :: Ha en egen f√∂rgrening, t.ex. f√∂r en viss feature, d√§r f√§rre utvecklare √§r inblandade.
- Strategi 2 :: Ha en egen f√∂rgrening av feature-f√∂rgreningen (local branch).

Men till slut r√§cker inte detta, utan du beh√∂ver kombinera grenarna.
- Din lokala gren med gruppens
- Feature-grenen med utvecklingsgrenen
- Utvecklingsgrenen med main-grenen
- I distribuerade CM-verktyg som =git= kan du ocks√• h√§mta en f√∂rgrening fr√•n en annan utvecklare.

*F√∂rr eller senare kommer du d√• beh√∂va hantera konflikter mellan grenarna.*
* diff -- Vad Skiljer sig √•t?
#+begin_src bash :results output
  cd /tmp
  echo "aaa" > first.txt ; echo "aaa" > second.txt
  echo "bbb" >> first.txt; echo "BBB" >> second.txt
  echo "ccc" >> first.txt; echo "ccc" >> second.txt
  echo "ddd" >> second.txt

  cat first.txt
  echo "----------"
  cat second.txt
  echo "----------"
  diff first.txt second.txt
#+end_src

#+RESULTS:
#+begin_example
aaa
bbb
ccc
----------
aaa
BBB
ccc
ddd
----------
2c2
< bbb
---
> BBB
3a4
> ddd
#+end_example

- Hur l√§ser vi detta?
- Helst inte; det finns bra verktyg f√∂r det.

#+begin_src bash :results none
meld /tmp/first.txt /tmp/second.txt
#+end_src
** Att l√§sa en diff :Extra:
#+begin_verse
CHANGE-COMMAND
< FROM-FILE-LINE
< FROM-FILE-LINE...
---
> TO-FILE-LINE
> TO-FILE-LINE...
#+end_verse

D√§r CHANGE-COMMAND √§r:
- =LaR= : Add the lines in range R of the second (right) file after line L in the first (left) file.
- =LcR= : Change the lines in range L of the first (left) file with the lines in range R of the second (right) file.
- =LdR= : Delete the lines in range L of the first (left) file, line R is where they would have appeared in the second (right) file.

* Three-Way Merge
:PROPERTIES:
:BEAMER_OPT: shrink=30
:END:

- Anv√§nder ett gemensamt ursprung f√∂r att avg√∂ra om f√∂r√§ndringar √§r nya eller inte.
- Skapar ibland lite nya problem
  - Vad h√§nder t.ex. i figuren nedan om "GG" anv√§nder sig av "AA"?
  - t.ex. en ~#include~ , eller en referens i text /"som tidigare n√§mnt"/
- N√§r b√•da filerna √§ndrats s√• m√•ste anv√§ndaren besluta (t.ex. =f or fff?= )
[[./threewaymerge.png]]

** 3-way
#+begin_src bash :results none
meld ./3way/base ./3way/source ./3way/target -o ./3way/merged
#+end_src
** 2-way
#+begin_src bash :results none
meld ./3way/source ./3way/target
#+end_src
* Fork av ett projekt
:PROPERTIES:
:BEAMER_OPT: shrink=20
:END:

- Specifikt f√∂r vissa github-servrar
- N√§r man vill bidra till ett projekt s√• b√∂rjar man med att skapa sin egen kopia, en =fork=
- Man arbetar sedan som vanligt.
- N√§r man √§r n√∂jd skapar man en =pull request= i originalprojektet
- √Ñgaren av originalprojektet kan d√• inspektera f√∂r√§ndringarna och (om de godk√§nner dem) g√∂ra en =merge= med sitt projekt.
- B√•da tv√• kan forts√§tta arbeta med sina respektive kopior av projektet. De beh√∂ver inte f√∂rena dem.
[[./git-fork.png]]
* TODO Sammanfattning
*Konfigurationshantering*
- Att programmera √§r att samarbeta
- Man utvecklar inte linj√§rt. Man g√∂r fel, man vill g√• tillbaka, man vill prova olika v√§gar.
- Det kr√§vs kraftfulla verktyg f√∂r att h√§nga med n√§r alla i ett projekt utvecklar icke-linj√§rt.
  - Verktyg f√∂r konfigurationshantering
- Vanligast idag: =git=
- St√∂rsta utmaningen:
  - Att ost√∂rt kunna arbeta i din egen f√∂rgrening
  - Att kunna j√§mka samman din kod med resten av projektet med hj√§lp av en =merge=.

*Anv√§nd Alltid Konfigurationshantering. Anv√§nd Konfigurationshantering till Allt.*
L√§r dig mantrat: /"If it's not committed, it does not exist!"/
